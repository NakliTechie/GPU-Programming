// Mental Model 11.0

// ... Host code ...

// ===================================
// Device (GPU) Code
// ===================================
__global__ void my_scan_kernel(...) {
  __shared__ float tile[...];
  
  // 1. Load data into shared memory.
  tile[threadIdx.x] = ...;
  __syncthreads();

  // 2. Iterate log(N) times to build up the prefix sum.
  for (stride = 1; stride < BLOCK_SIZE; stride *= 2) {
      
      // PHASE 1: READ
      // Read OLD values from shared memory. Store new value in a private register.
      if (threadIdx.x >= stride) {
          temp_reg = tile[threadIdx.x] + tile[threadIdx.x - stride];
      }

      // BARRIER 1: Critical for preventing Write-After-Read (WAR) hazard.
      // Ensures all threads have finished reading the old state.
      __syncthreads();

      // PHASE 2: WRITE
      // Now, safely write the new values back to shared memory.
      if (threadIdx.x >= stride) {
          tile[threadIdx.x] = temp_reg;
      }

      // BARRIER 2: Ensures all threads have finished writing the new state
      // before the next iteration begins.
      __syncthreads();
  }

  // 3. Write final results back to global memory.
  global_output[...] = tile[threadIdx.x];
}